name: GitHub to Discord Bot

on:
  push:
  pull_request:
    types: [opened, edited, closed, reopened, synchronize]
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord message
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          EVENT: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
        run: |
          MESSAGE=""

          if [ "$EVENT" = "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ACTION="${{ github.event.action }}"
            ISSUE_URL="${{ github.event.issue.html_url }}"
            MESSAGE="üìò Issue [#${ISSUE_NUMBER}](${ISSUE_URL}) '${ISSUE_TITLE}' was **${ACTION}** by ${ACTOR} in ${REPO}"

          elif [ "$EVENT" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            ACTION="${{ github.event.action }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            MESSAGE="üîÄ PR [#${PR_NUMBER}](${PR_URL}) '${PR_TITLE}' was **${ACTION}** by ${ACTOR} in ${REPO}"

          elif [ "$EVENT" = "issue_comment" ]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_URL="${{ github.event.issue.html_url }}"
            MESSAGE="üí¨ New comment on [#${ISSUE_NUMBER}](${ISSUE_URL}) by ${ACTOR}: '${COMMENT_BODY}'"

          elif [ "$EVENT" = "push" ]; then
            BRANCH="${{ github.ref_name }}"
            # Count commits using jq
            COMMIT_COUNT=$(echo '${{ toJson(github.event.commits) }}' | jq '. | length')
            MESSAGE="üìù ${ACTOR} pushed ${COMMIT_COUNT} commit(s) to branch ${BRANCH} in ${REPO}"

          else
            MESSAGE="üîî Event ${EVENT} triggered by ${ACTOR} in ${REPO}"
          fi

          # Send message to Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"${MESSAGE}\"}" \
               "$DISCORD_WEBHOOK_URL"
